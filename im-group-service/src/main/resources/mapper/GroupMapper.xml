<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mi.im.group.mapper.GroupMapper">
    
    <!-- 插入群组信息 -->
    <insert id="insert" parameterType="com.mi.im.group.entity.Group" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO `group` (group_name, group_avatar, description, owner_id, member_count, max_members, status, create_time, update_time, ext_info)
        VALUES (#{groupName}, #{groupAvatar}, #{description}, #{ownerId}, #{memberCount}, #{maxMembers}, #{status}, #{createTime}, #{updateTime}, #{extInfo})
    </insert>
    
    <!-- 根据ID查询群组信息 -->
    <select id="selectById" parameterType="java.lang.Long" resultType="com.mi.im.group.entity.Group">
        SELECT * FROM `group` WHERE id = #{id}
    </select>
    
    <!-- 更新群组信息 -->
    <update id="updateById" parameterType="com.mi.im.group.entity.Group">
        UPDATE `group`
        SET group_name = #{groupName},
            group_avatar = #{groupAvatar},
            description = #{description},
            member_count = #{memberCount},
            max_members = #{maxMembers},
            status = #{status},
            update_time = #{updateTime},
            ext_info = #{extInfo}
        WHERE id = #{id}
    </update>
    
    <!-- 查询用户加入的群组列表 -->
    <select id="selectUserGroups" parameterType="java.lang.Long" resultType="com.mi.im.group.entity.Group">
        SELECT g.* FROM `group` g
        INNER JOIN group_member gm ON g.id = gm.group_id
        WHERE gm.user_id = #{userId} AND gm.status = 0 AND g.status = 0
        ORDER BY g.update_time DESC
    </select>
    
    <!-- 根据ID列表查询群组信息 -->
    <select id="selectByIds" parameterType="java.util.List" resultType="com.mi.im.group.entity.Group">
        SELECT * FROM `group` WHERE id IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
    
    <!-- 更新群组状态 -->
    <update id="updateStatus">
        UPDATE `group` SET status = #{status} WHERE id = #{id}
    </update>
    
    <!-- 搜索群组 -->
    <select id="searchGroups" resultType="com.mi.im.group.entity.Group">
        SELECT * FROM `group`
        WHERE status = 0 AND (group_name LIKE CONCAT('%', #{keyword}, '%') OR description LIKE CONCAT('%', #{keyword}, '%'))
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 统计搜索结果数量 -->
    <select id="countSearchGroups" parameterType="java.lang.String" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM `group`
        WHERE status = 0 AND (group_name LIKE CONCAT('%', #{keyword}, '%') OR description LIKE CONCAT('%', #{keyword}, '%'))
    </select>
</mapper>